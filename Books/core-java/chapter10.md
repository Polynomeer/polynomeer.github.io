# 10장 병행 프로그래밍

자바는 병행 프로그래밍을 자체적으로 지원하는 초창기 프로그래밍 언어였다. 초기에 자바 프로그래머는 백그라운드 스레드에서 이미지를 로드하거나 여러 요청을 동시에 처리하는 웹 서버를 구현하는데 열정을 쏟았다. 당시에는 일부 태스크가 네트워크에서 대기하는 동안 프로세서가 바쁘게 작동하도록 만드는데 초점을 맞추었다. 요즘에는 대부분의 컴퓨터가 멀티 프로세서 또는 코어를 갖추고 있어 프로그래머는 모든 프로세서를 바쁘게 작동하도록 만드는데 신경을 쓴다. (멀티스레딩)

## 10.1 병행 태스크

병행(동시 실행) 프로그램을 설계할 때는 같이 실행할 수 있는 태스크들을 생각해야한다.

### 10.1.1 태스크 실행

자바에서 Runnable 인터페이스는 다른 태스크와 동시에 실행하려는 태스크 단위를 나타낸다. 모든 메서드가 그렇듯이 run 메서드는 스레드 안에서 실행된다. 스레드는 일련의 명령어를 실행하는 메커니즘으로, 일반적으로 운영체제가 제공한다. 별도의 프로세서 또는 같은 프로세서의 서로 다은 타임 슬라이스를 이용해 여러 스레드를 동시에 실행한다.

별도의 스레드에서 Runnable을 실행하려면 해당 Runnable을 실행한 스레드를 만들면 된다. 하지만 실무에서 태스크와 스레드를 일대일로 만드는 것은 바람직하지 않다. 예를 들어, 짧은 시간 실행되는 태스크일 때는 스레드를 시작하는 데 드는 시간을 낭비하지 말고, 같은 스레드에서 다수를 실행하는 것이 좋다. 그리고 강도 높은 계산을 수행하는 태스크일 때는 태스크별로 스레드를 사용하는 대신, 프로세서별로 스레드를 하나씩 사용해 스레드 사이에서 전환하는 오버헤드를 피하면 좋다. 태스크를 설계할 때는 그냥 태스크와 태스크 스케줄링을 분리하는 것이 좋다.

ExecutorService 는 태스크를 스케줄링하고 해당 태스크를 수행할 스레드를 선택해 실행한다.
Executors 클래스에는 스케줄링 정책이 서로 다른 실행자 서비스를 만드는 팩토리 메서드가 있다.
Executors::newCachedThreadPool - 수명이 짧거나 대부분의 시간을 대기하며 보내는 태스크를 다수 포함하는 프로그램에 최적화된 실행자 서비스를 돌려준다.
Executors::newFixedThreadPool - 고정 개수 스레드풀을 돌려준다. 태스크를 제출하면 해당 태스크는 스레드를 이용할 수 있을 때까지 큐에 머문다.
고정 개수 스레드 풀은 계산 집약적인 태스크에 사용하거나 서비스의 리소스 소비를 제한하는 데 적합하다.

```java
public class RunnableDemo {
    public static void main(String[] args) {
        Runnable hellos = () -> {
            for (int i = 1; i <= 1000; i++) 
                System.out.println("Hello " + i);
        };
        Runnable goodbyes = () -> {
            for (int i = 1; i <= 1000; i++) 
                System.out.println("Goodbye " + i);
        };
        
        ExecutorService executor = Executors.newCachedThreadPool();
        executor.execute(hellos);        
        executor.execute(goodbyes);
        executor.shutdown();
    }
}
```
출력이 어떤식으로 섞이는지 확인해보면 매번 다름을 확인할 수 있다.

```note
마지막 출력 후에 아주 잠깐 대기하는데, 이는 스레드 풀에 속한 스레드가 잠시 유휴 상태에 있어 ExecutorService가 이를 종료할 때 종료되기 때문이다.
```

```warning
병행 태스크들이 공유값을 읽거나 수정하면 그 결과를 예측할 수 없다. 즉, 동시성 문제가 발생하기 때문에 별도의 제어가 필요하다.
```
